#ifdef VIDEO_TRANSPORT_SYSV

#include "sysvshmtransport.h"

#include <sys/shm.h>


SysVSHMTransport::SysVSHMTransport()
{
}

SysVSHMTransport::~SysVSHMTransport()
{
}


bool SysVSHMTransport::Allocate( bufferstruct *b )
{
	b->pitch = pitchfor( (unsigned long)b->colorspace, b->bitcount, b->width, b->height );
	if ( b->pitch == 0 )
		return false;
	b->bufid = shmget( IPC_PRIVATE, b->pitch*b->height, IPC_CREAT|0777);
	if ( b->bufid == -1 )
		return false;
	b->type = SkypekitVideoTransportBase::SysVSHMBuffer;
	b->clientdata = (uint64)shmat( b->bufid, 0, 0 );
	return true;
}

void SysVSHMTransport::FreeBuffer( bufferstruct *b )
{
	if ( b->clientdata )
		shmdt( (void *)b->clientdata );
	b->clientdata = 0;
	shmctl( b->bufid, IPC_RMID, NULL );
	b->bufid = -1;
}

void *SysVSHMTransport::DataForBuffer( bufferstruct *b )
{
	return (void *)b->clientdata;
}

bool SysVSHMTransport::Present( bufferstruct *b, long long ts )
{
	return Present( (void *)b->clientdata, b, ts );
}

bool SysVSHMTransport::Present( void *data, bufferstruct *b, long long ts )
{
	return true;
}
#endif
