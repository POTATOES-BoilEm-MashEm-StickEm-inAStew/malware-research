#ifndef Factories_HPP_INCLUDED
#define Factories_HPP_INCLUDED 

#include "SidPlatform.hpp"
#include "SidProtocolServerInterface.hpp"

namespace Sid {

  struct TransportInterface;

  class ProtocolFactory {
  public:
    static Protocol::ServerInterface* create(const String& protocol, TransportInterface* transport);
    ProtocolFactory(const String& name, Protocol::ServerInterface* (*constructor)(TransportInterface*));
  private:
    Protocol::ServerInterface* create_protocol(const String& protocol_name, TransportInterface* transport);
    ProtocolFactory* m_next;
    Protocol::ServerInterface* (*m_constructor)(TransportInterface*);
    String m_name;
    static ProtocolFactory* M_protocol_factory;
  };

  template<class ProtocolImpl> class ProtocolRegistration : protected ProtocolFactory {
  public:
    ProtocolRegistration(const String& name) 
    : ProtocolFactory(name, &constructor)
    { }
  private:
    static Protocol::ServerInterface* constructor(TransportInterface* transport)
    { return new ProtocolImpl(0, transport); }
  };
}

#endif
