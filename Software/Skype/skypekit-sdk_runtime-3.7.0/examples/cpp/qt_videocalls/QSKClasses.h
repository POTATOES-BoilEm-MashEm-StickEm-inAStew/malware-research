#ifndef QSKCLASSES_H
#define QSKCLASSES_H

#include <QtGui/QApplication>
#include <mainwindow.h>
#include "skype-embedded_2.h"

extern MainWindow*  mainForm;

/**---------------------------------------------------------------------------------------
Dispatcher class. Instance of this class will handle all the communication between
SkypeKit classes and UI classes. The reason we need this is that SkypeKit class events
do not fire from the main UI thread.

For example: once an Account object obtains logged in status, we will want to disable
the login button and enable the Call button. It would be easy to just call appropriate
mainForm methods - but this will cause your app to crash - as Account::OnChange callback
will get fired from somewhere in the wrapper thread pool.

An easy way to flatten the SkypeKit-GUI communication without writing your own event queue
would be to re-use Qt signals and slots. In theory it is possible to use multiple inheritance
for this - to have you SkypeKit class descendants inherit from QObject as well. On the other
hand, multiple inheritance can get messy. So in this case we will use a single object -
a QObject descendant - as our central event dispatcher.

Instead of calling:
mainForm->enableCallButton(true)

we define a signal: QSKSignalDispatcher::EnableCallBtnSignal
a method that emits the signal: QSKSignalDispatcher::SendEnableLoginBtnSignal
and a corresponding slot: MainWindow::on_EnableCallBtn

After connecting these two, and having dispatcher object available in global scope, we can
use dispatcher->SendEnableCallBtnSignal(bool) from our SkypeKit callbacks without UI crashing.
**/

class QSKSignalDispatcher : public QObject
{
    Q_OBJECT

public:
    void ConnectToUI();

    void log(QString S)
        { emit SendToLogSignal(S); }

    void SendUpdateContactListSignal ()
        { emit UpdateContactListSignal (); }

    void SendEnableLoginBtnSignal (bool B)
        { emit EnableLoginBtnSignal (B); }

    void SendEnableCallBtnSignal (bool B)
        { emit EnableCallBtnSignal (B); }

    void SendToggleCallBtnDropsCallSignal (bool B)
        { emit ToggleCallBtnSignal (B); }

    void SendToggleVideoWindowSignal (bool B)
        { emit ToggleVideoWindowSignal (B); }

signals:
    void SendToLogSignal (QString);
    void UpdateContactListSignal ();
    void EnableLoginBtnSignal (bool);
    void EnableCallBtnSignal (bool);
    void ToggleCallBtnSignal (bool);
    void ToggleVideoWindowSignal (bool);    

public slots:
    void on_PlaceCall (QString target);
};

extern QSKSignalDispatcher* dispatcher;



//---------------------------------------------------------------------------------------
// Account class declaration

class QSKAccount : public Account
{
public:
    typedef DRef<QSKAccount, Account> Ref;
    typedef DRefs<QSKAccount, Account> Refs;
    QSKAccount(unsigned int oid, SERootObject* root) : Account(oid, root) {}
    void OnChange(int prop);
};


//---------------------------------------------------------------------------------------
// ContactGroup class declaration

class QSKContactGroup : public ContactGroup
{
public:
    typedef DRef<QSKContactGroup, ContactGroup> Ref;
    typedef DRefs<QSKContactGroup, ContactGroup> Refs;
    QSKContactGroup(unsigned int oid, SERootObject* root) : ContactGroup(oid, root) {}
    void OnChange(const ContactRef& contact);
};


//---------------------------------------------------------------------------------------
// Video class declaration

class QSKVideo : public Video
{
public:
    typedef DRef<QSKVideo, Video> Ref;
    typedef DRefs<QSKVideo, Video> Refs;
    QSKVideo(unsigned int oid, SERootObject* root) : Video(oid, root) {}
    void OnChange(int prop);
};


//---------------------------------------------------------------------------------------
// Participant class declaration

class QSKParticipant : public Participant
{
public:
    typedef DRef<QSKParticipant, Participant> Ref;
    typedef DRefs<QSKParticipant, Participant> Refs;

    QSKParticipant(unsigned int oid, SERootObject* root) : Participant(oid, root) {}
    void OnChange(int prop);
};


//---------------------------------------------------------------------------------------
// Conversation class declaration

class QSKConversation : public Conversation
{
public:
    typedef DRef<QSKConversation, Conversation> Ref;
    typedef DRefs<QSKConversation, Conversation> Refs;

    QSKConversation(unsigned int oid, SERootObject* root) : Conversation(oid, root) {}
    
    ParticipantRefs LiveParticipants;
    void OnChange(int prop);

    void PickUpCall();
};


//---------------------------------------------------------------------------------------
// Skype class declaration

class QSKSkype : public Skype
{
public:
    QSKSkype() : Skype()
    {
        account         = NULL;
        isLoggedIn      = false;
        isLiveSessionUp = false;
        liveSession     = NULL;
        remoteVideo     = NULL;
        localVideo      = NULL;
        previewVideo    = NULL;
    };

    Account*        newAccount(int oid)         { return new QSKAccount(oid, this);}
    ContactGroup*   newContactGroup(int oid)    { return new QSKContactGroup(oid, this);}
    Video*          newVideo(int oid)           { return new QSKVideo(oid, this);}
    Participant*    newParticipant(int oid)     { return new QSKParticipant(oid, this);}
    Conversation*   newConversation(int oid)    { return new QSKConversation(oid, this);}

    AccountRef      account;
    bool            isLoggedIn;
    bool            isLiveSessionUp;
    ConversationRef liveSession;
    VideoRef        remoteVideo;
    VideoRef        localVideo;
    VideoRef        previewVideo;

    ContactGroupRef allBuddiesGroup;
    ContactRefs     allBuddies;

    void OnConversationListChange(
        const ConversationRef &conversation,
        const Conversation::LIST_TYPE &type,
        const bool &added);

    void PlaceCall(QString target);
};

extern QSKSkype* skype;

#endif // QSKCLASSES_H
