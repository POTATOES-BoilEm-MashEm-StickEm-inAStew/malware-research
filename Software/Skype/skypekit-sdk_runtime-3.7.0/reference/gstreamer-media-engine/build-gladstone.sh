#!/bin/sh

G729_URL=$1
G729_FILENAME="T-REC-G.729-200701-I!!SOFT-ZST-E.zip"
G729_CHECKSUM=d8c443b6628ee415382f8435eeccc766
BASE_DIR=`pwd`
LOG=$BASE_DIR/gladstone.log 

if [ x"$G729_URL" == "x" ]; then
    echo "Usage $0 <url>" | tee -a $LOG
    echo "" | tee -a $LOG
    echo "You must provide the download URL to the ITU's implementation of G729" | tee -a $LOG
    echo "Go to http://www.itu.int/rec/T-REC-G.729-200701-I/en and copy the" | tee -a $LOG
    echo "link address of the .zip archive and use that as the argument to" | tee -a $LOG
    echo "this script." | tee -a $LOG

    exit 1
fi

if [ x"$G729_URL" == "xhttp://www.itu.int/rec/T-REC-G.729-200701-I/en" ]; then
    echo "You must provide the URL to the zip file contained within that page" | tee -a $LOG
    exit 1
fi

echo "" > $LOG 2>&1

if [ ! -d itu-g729 ]; then
    echo "***************** Creating itu-g729 directory for download  *******************" | tee -a $LOG
    mkdir itu-g729
    if [ $? != 0 ]; then
	echo "Error creating itu-g729 directory." | tee -a $LOG
	echo "Make sure you have permissions to write to this directory" | tee -a $LOG
	exit 1
    fi
fi

cd itu-g729
CHECKSUM=""
if [ -f $G729_FILENAME ]; then
    echo "*****************       Found file, verifying checksum      *******************"  | tee -a $LOG 
    CHECKSUM=`md5sum $G729_FILENAME | awk '{ print $1}'`
fi

if [ x"$CHECKSUM" != x"$G729_CHECKSUM" ];then
    echo "***************** Downloading G729 reference implementation *******************" | tee -a $LOG
    wget --continue -O $G729_FILENAME $G729_URL >> $LOG 2>&1

    if [ $? != 0 ]; then
	echo "Could not download ITU reference implementation" | tee -a $LOG
	echo "Make sure you have specified the correct URL" | tee -a $LOG
	echo "** See gladstone.log for more information on the error encountered **" | tee -a $LOG
	exit 1
    fi

    echo "*****************             Verifying checksum            *******************" | tee -a $LOG
    CHECKSUM=`md5sum $G729_FILENAME | awk '{print $1}'`

    if [ x"$CHECKSUM" != x"$G729_CHECKSUM" ]; then
	rm -f $G729_FILENAME
	echo "Downloaded file has the wrong checksum." | tee -a $LOG
	echo "Make sure you have used the correct URL" | tee -a $LOG
	exit 1
    else
	echo "*****************              Checksum matched             *******************" | tee -a $LOG
    fi
else
    echo "*****************              Checksum matched             *******************" | tee -a $LOG
fi

echo "*****************             Extracting archive            *******************" | tee -a $LOG
unzip -u $G729_FILENAME >> $LOG 2>&1
if [ $? != 0 ]; then
    echo "Error unzipping the file" | tee -a $LOG
    echo "** See gladstone.log for more information on the error encountered **" | tee -a $LOG
    exit 1
fi

echo "*****************               Renaming files              *******************" | tee -a $LOG
cd Soft/g729AnnexA/c_code/
for file in *; do
    new_file=`echo $file | awk '{print tolower($0)}'`
    if [ "$file" != "$new_file" ]; then
	mv $file $new_file
    fi
done

export G729_PATH=`pwd`

cd $BASE_DIR

rm -rf gladstone
echo "*****************            Downloading gladstone          *******************" | tee -a $LOG
svn export -r10 http://gladstone.googlecode.com/svn/trunk/ gladstone >> $LOG 2>&1
if [ $? != 0 ]; then
    echo "Error downloading gladstone" | tee -a $LOG
    echo "** See gladstone.log for more information on the error encountered **" | tee -a $LOG
    exit 1
fi

cd gladstone

echo "*****************              Generating patch             *******************" | tee -a $LOG

cat > gladstone.patch << EOF
Index: autogen.sh
===================================================================
--- autogen.sh	(revision 10)
+++ autogen.sh	(working copy)
@@ -17,7 +17,7 @@
 fi
 . ./gst-autogen.sh
 
-CONFIGURE_DEF_OPT='--enable-maintainer-mode --enable-debug'
+CONFIGURE_DEF_OPT=''
 
 autogen_options \$@
 
Index: src/gstg729dec.c
===================================================================
--- src/gstg729dec.c    (revision 10)
+++ src/gstg729dec.c    (working copy)
@@ -545,7 +545,7 @@
   /* now decode each frame */
   for (i = 0; i < fpp; i++) {
     GstBuffer *outbuf;
-    gint16 *out_data;
+    guint8 *out_data;
 
     res = gst_pad_alloc_buffer_and_set_caps (dec->srcpad,
         GST_BUFFER_OFFSET_NONE, RAW_FRAME_BYTES,
@@ -556,7 +556,7 @@
       return res;
     }
 
-    out_data = (gint16 *) GST_BUFFER_DATA (outbuf);
+    out_data = GST_BUFFER_DATA (outbuf);
 
     res = g729_decode (dec, data+i*G729_FRAME_BYTES, out_data);
 
@@ -572,15 +572,15 @@
 
     GST_BUFFER_OFFSET (outbuf) = dec->granulepos - RAW_FRAME_SAMPLES;
     GST_BUFFER_OFFSET_END (outbuf) = dec->granulepos;
-    GST_BUFFER_TIMESTAMP (outbuf) = timestamp;
-    GST_BUFFER_DURATION (outbuf) = FRAME_DURATION;
+    GST_BUFFER_TIMESTAMP (outbuf) = timestamp + 100 * GST_MSECOND;
+    GST_BUFFER_DURATION (outbuf) = 10 * GST_MSECOND;
 
     dec->granulepos += RAW_FRAME_SAMPLES;
-    dec->segment.last_stop += FRAME_DURATION;
+    dec->segment.last_stop = GST_BUFFER_TIMESTAMP (outbuf);
 
     GST_LOG_OBJECT (dec, "pushing buffer with ts=%" GST_TIME_FORMAT ", dur=%"
-        GST_TIME_FORMAT, GST_TIME_ARGS (timestamp),
-        GST_TIME_ARGS (FRAME_DURATION));
+        GST_TIME_FORMAT, GST_TIME_ARGS (GST_BUFFER_TIMESTAMP (outbuf)),
+        GST_TIME_ARGS (GST_BUFFER_DURATION (outbuf)));
 
     res = gst_pad_push (dec->srcpad, outbuf);
 
@@ -588,7 +588,7 @@
       GST_DEBUG_OBJECT (dec, "flow: %s", gst_flow_get_name (res));
       break;
     }
-    timestamp = -1;
+    timestamp += GST_BUFFER_DURATION (outbuf);
   }
 
   return res;
Index: src/Makefile.am
===================================================================
--- src/Makefile.am     (revision 10)
+++ src/Makefile.am     (working copy)
@@ -41,7 +41,7 @@
 libgstg729_la_CFLAGS = \$(GST_CFLAGS) \$(GST_BASE_CFLAGS) -I \$(G729_PATH)
 libgstg729_la_LIBADD = \$(GST_LIBS) \$(GST_BASE_LIBS) libg729_ref.a
 
-libgstg729_la_LDFLAGS = \$(GST_PLUGIN_LDFLAGS) -L \$(G729_PATH)
+libgstg729_la_LDFLAGS = \$(GST_PLUGIN_LDFLAGS) -L\$(G729_PATH)
 libgstg729_la_LIBTOOLFLAGS = --tag=disable-static
 
 # headers we need but don't want installed
Index: src/gstg729enc.c
===================================================================
--- src/gstg729enc.c    (revision 10)
+++ src/gstg729enc.c    (working copy)
@@ -581,7 +581,10 @@
 
   enc->bytes_out += size;
 
-  GST_DEBUG_OBJECT (enc, "pushing output buffer of size %u", size);
+  GST_DEBUG_OBJECT (enc, "pushing output buffer of size %u and ts=%"
+      GST_TIME_FORMAT " duration=%" GST_TIME_FORMAT, size,
+      GST_TIME_ARGS (GST_BUFFER_TIMESTAMP (buffer)),
+      GST_TIME_ARGS (GST_BUFFER_DURATION (buffer)));
 
   return gst_pad_push (enc->srcpad, buffer);
 }
@@ -648,6 +651,10 @@
 gst_g729_enc_encode (GstG729Enc * enc, gboolean flush)
 {
   GstFlowReturn ret = GST_FLOW_OK;
+  int f = 0;
+  guint64 distance;
+  GstClockTime ts = gst_adapter_prev_timestamp (enc->adapter, &distance);
+  ts += gst_util_uint64_scale_int (distance/2, GST_SECOND, SAMPLE_RATE);
 
   if (flush && gst_adapter_available (enc->adapter) % RAW_FRAME_BYTES != 0) {
     guint diff = gst_adapter_available (enc->adapter) % RAW_FRAME_BYTES;
@@ -669,6 +676,7 @@
 
     enc->frameno++;
     enc->frameno_out++;
+    f++;
 
     ret = gst_pad_alloc_buffer_and_set_caps (enc->srcpad,
         GST_BUFFER_OFFSET_NONE, G729_FRAME_BYTES, GST_PAD_CAPS (enc->srcpad), &outbuf);
@@ -681,9 +689,9 @@
     g_free (data);
     g_assert (out == G729_FRAME_BYTES);
 
-    GST_BUFFER_TIMESTAMP (outbuf) = enc->start_ts +
-        gst_util_uint64_scale_int ((enc->frameno_out - 1) * RAW_FRAME_SAMPLES,
-        GST_SECOND, SAMPLE_RATE);
+    GST_BUFFER_TIMESTAMP (outbuf) = ts + 100 * GST_MSECOND +
+        gst_util_uint64_scale_int ((f - 1) * RAW_FRAME_SAMPLES,
+            GST_SECOND, SAMPLE_RATE);
     GST_BUFFER_DURATION (outbuf) = gst_util_uint64_scale_int (RAW_FRAME_SAMPLES,
         GST_SECOND, SAMPLE_RATE);
     GST_BUFFER_OFFSET_END (outbuf) = enc->granulepos_offset +
@@ -692,6 +700,7 @@
         gst_util_uint64_scale_int (GST_BUFFER_OFFSET_END (outbuf), GST_SECOND,
         SAMPLE_RATE);
 
+
     ret = gst_g729_enc_push_buffer (enc, outbuf);
 
     if ((GST_FLOW_OK != ret) && (GST_FLOW_NOT_LINKED != ret))
@@ -780,8 +789,12 @@
   else
     enc->next_ts = GST_CLOCK_TIME_NONE;
 
-  GST_DEBUG_OBJECT (enc, "received buffer of %u bytes", GST_BUFFER_SIZE (buf));
+  GST_DEBUG_OBJECT (enc, "received buffer of %u bytes, ts=%" GST_TIME_FORMAT
+      " dur=%" GST_TIME_FORMAT, GST_BUFFER_SIZE (buf),
+      GST_TIME_ARGS (GST_BUFFER_TIMESTAMP (buf)),
+      GST_TIME_ARGS (GST_BUFFER_DURATION (buf)));
 
+
   /* push buffer to adapter */
   gst_adapter_push (enc->adapter, buf);
   buf = NULL;
EOF


echo "*****************             Patching gladstone            *******************" | tee -a $LOG
patch -p0 < gladstone.patch >> $LOG 2>&1

if [ $? != 0 ]; then
    echo "Error patching gladstone" | tee -a $LOG
    echo "** See gladstone.log for more information on the error encountered **" | tee -a $LOG
    exit 1
fi

echo "*****************           Configuring gladstone           *******************" | tee -a $LOG
./autogen.sh >> $LOG 2>&1

if [ $? != 0 ]; then
    echo "Error configuring gladstone" | tee -a $LOG
    echo "** See gladstone.log for more information on the error encountered **" | tee -a $LOG
    exit 1
fi

echo "*****************             Building gladstone            *******************" | tee -a $LOG
make >> $LOG 2>&1

if [ $? != 0 ]; then
    echo "Error building gladstone" | tee -a $LOG
    echo "** See gladstone.log for more information on the error encountered **" | tee -a $LOG
    exit 1
fi

echo "*****************        Gladstone build successfully       *******************" | tee -a $LOG
echo "" | tee -a $LOG
echo "" | tee -a $LOG
echo "*******************************************************************************" | tee -a $LOG
echo "*******************************************************************************" | tee -a $LOG
echo "*** Now go to the gladstone directory and type 'make install' to install it ***" | tee -a $LOG
echo "** IMPORTANT : This scrpit does not install gladstone, it simply builds it. ***" | tee -a $LOG
echo "** This is to allow you to install it to the appropriate DESTDIR on your system" | tee -a $LOG
echo "*******************************************************************************" | tee -a $LOG
echo "*******************************************************************************" | tee -a $LOG
